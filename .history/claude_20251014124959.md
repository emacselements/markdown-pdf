# Claude.md - Development Notes for markdown-pdf.el

This document contains development notes, design decisions, and technical details for the `markdown-pdf.el` Emacs package.

## Project Overview

`markdown-pdf.el` is an Emacs Lisp package that bridges the gap between Emacs markdown editing and high-quality PDF export. It was created to bring VSCode's "Markdown PDF" extension functionality to Emacs users.

## Architecture

### Core Components

1. **Configuration System** - Customizable variables using Emacs' defcustom system
2. **CSS Management** - Built-in default CSS with option for custom CSS files
3. **Pandoc Integration** - Wrapper around Pandoc for document conversion
4. **PDF Engine Detection** - Automatic detection of available PDF engines
5. **File Management** - Smart output path generation and temporary file handling

### Design Decisions

#### Why Pandoc?
- Industry standard for document conversion
- Excellent markdown support with extensions
- Multiple output formats
- Active development and community

#### CSS Strategy
The package includes a comprehensive default CSS that mimics VSCode's markdown preview:
- Uses system fonts for better OS integration
- Responsive design principles
- Professional typography with proper spacing
- Syntax highlighting support

#### PDF Engine Priority
1. **WeasyPrint** - Best CSS support, modern HTML/CSS rendering
2. **pdflatex** - Traditional LaTeX quality, good for academic documents
3. **xelatex** - Unicode support, better font handling

## Implementation Details

### Key Functions

#### `markdown-pdf-export`
Main export function that orchestrates the entire process:
1. Validates prerequisites (pandoc, file saved)
2. Generates output path
3. Creates temporary CSS and HTML files
4. Calls pandoc with appropriate arguments
5. Cleans up temporary files
6. Opens PDF if configured

#### `markdown-pdf--get-css-file`
Handles CSS file management:
- Returns custom CSS path if provided
- Creates temporary CSS file with default styles
- Ensures cleanup of temporary files

#### `markdown-pdf--find-available-engine`
Discovers available PDF engines on the system:
- Iterates through preferred engine list
- Uses `executable-find` for reliable detection
- Falls back gracefully if no engines found

### Error Handling

The package implements comprehensive error handling:
- Validates pandoc availability before export
- Checks file save status
- Ensures output directory exists
- Reports pandoc exit codes
- Graceful degradation for missing PDF engines

### Temporary File Management

Careful handling of temporary files:
- Uses `make-temp-file` for security
- Automatic cleanup in all code paths
- Separate handling for CSS and HTML temporary files

## Customization Philosophy

The package follows Emacs conventions for customization:
- All user-facing options use `defcustom`
- Grouped under `markdown-pdf` customization group
- Sensible defaults that work out of the box
- Clear documentation for each option

## Integration Points

### Markdown Mode Integration
- Automatic keybinding setup when markdown-mode is loaded
- Uses `eval-after-load` for proper initialization order
- Respects existing markdown-mode keybindings

### System Integration
- Cross-platform PDF opening (macOS, Linux, Windows)
- Proper shell command execution
- Path handling that works across platforms

## Performance Considerations

### Efficient Processing
- Minimal file I/O operations
- Reuses temporary files when possible
- Lazy loading of dependencies

### Memory Management
- Temporary buffers cleaned up automatically
- CSS stored as string constant (no file I/O for default CSS)
- Minimal memory footprint

## Future Enhancement Ideas

### Potential Features
1. **Multiple Export Formats** - HTML, DOCX, EPUB support
2. **Template System** - Multiple built-in CSS themes
3. **Live Preview** - Real-time PDF preview in Emacs
4. **Batch Export** - Export multiple files at once
5. **Table of Contents** - Automatic TOC generation
6. **MathJax Support** - Better math equation rendering
7. **Image Processing** - Automatic image optimization
8. **Bibliography** - BibTeX integration for citations

### Code Organization Improvements
1. **Modular Design** - Split into multiple files
2. **Test Suite** - Comprehensive ERT test coverage
3. **CI/CD** - Automated testing and packaging
4. **Documentation** - Texinfo manual generation

## Dependencies Analysis

### Required Dependencies
- **Emacs 25.1+** - Uses modern Emacs features
- **Pandoc** - Core conversion engine

### Optional Dependencies
- **markdown-mode** - Enhanced integration (soft dependency)
- **PDF engines** - Better output quality

### Dependency Management Strategy
- Minimal required dependencies for maximum compatibility
- Graceful degradation when optional dependencies missing
- Clear error messages for missing required dependencies

## Testing Strategy

### Current Testing
- Manual testing across different platforms
- Integration testing with various markdown files
- CSS rendering validation

### Recommended Testing Improvements
1. **Unit Tests** - Individual function testing
2. **Integration Tests** - End-to-end export testing
3. **Platform Tests** - Cross-platform compatibility
4. **Performance Tests** - Large file handling
5. **Regression Tests** - Prevent feature breakage

## Packaging Considerations

### MELPA Preparation
- Package metadata properly formatted
- Dependencies correctly specified
- Autoload cookies in appropriate places
- Clean, lintable code

### Version Management
- Semantic versioning (major.minor.patch)
- Changelog maintenance
- Backward compatibility considerations

## Security Considerations

### File Handling
- Proper temporary file creation
- Safe file path operations
- Input validation for file paths

### Command Execution
- Controlled pandoc argument passing
- Safe shell command execution
- Prevention of command injection

## Performance Benchmarks

### Typical Performance
- Small files (< 10KB): < 1 second
- Medium files (100KB): 2-3 seconds
- Large files (1MB+): 5-10 seconds

### Bottlenecks
- Pandoc execution time (dominant factor)
- PDF engine rendering (secondary factor)
- File I/O operations (minimal impact)

## Conclusion

`markdown-pdf.el` represents a well-architected solution for markdown to PDF conversion in Emacs. The code follows Emacs Lisp best practices, provides extensive customization options, and integrates cleanly with the Emacs ecosystem. The package fills an important gap in the Emacs markdown workflow and provides a foundation for future enhancements.